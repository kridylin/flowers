<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ÊàëÁöÑÊ≤ªÊÑàËä±Âõ≠</title>
    <style>
        :root {
            --bg-color: #E9F7EF;
            --font-stack: "Songti SC", "Noto Serif SC", serif;
            --text-color: #5A5A5A;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body, html {
            width: 100%; height: 100%;
            background-color: var(--bg-color);
            overflow: hidden;
            font-family: var(--font-stack);
            color: var(--text-color);
            touch-action: none;
            background: linear-gradient(135deg, #E9F7EF 0%, #F5FAFF 100%);
            user-select: none;
        }

        #app {
            position: relative; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
        }

        canvas { position: absolute; top: 0; left: 0; z-index: 1; }

        /* Ê®°ÊÄÅÊ°ÜÊ†∑Âºè */
        #choice-modal {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(233, 247, 239, 0.95);
            z-index: 50;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            padding: 20px;
            opacity: 0;
            transition: opacity 0.6s;
            pointer-events: none;
        }
        #choice-modal.show { opacity: 1; pointer-events: auto; }

        .choice-content { text-align: center; max-width: 600px; }
        .choice-title { font-size: 24px; letter-spacing: 2px; color: #4A6B5D; margin-bottom: 30px; line-height: 1.6; }
        .choice-subtitle { font-size: 14px; color: #8FAFA0; margin-bottom: 40px; letter-spacing: 1px; }
        .choice-buttons { display: flex; flex-direction: column; gap: 12px; margin-bottom: 30px; }

        .choice-btn {
            background: linear-gradient(135deg, #A8E6CF, #DCEDC1);
            color: #4A6B5D; border: 2px solid transparent;
            padding: 14px 24px; font-family: var(--font-stack);
            font-size: 15px; letter-spacing: 1px; cursor: pointer;
            border-radius: 30px; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(168, 230, 207, 0.3); transform: scale(1);
        }
        .choice-btn:hover { transform: translateY(-2px) scale(1.02); box-shadow: 0 6px 20px rgba(168, 230, 207, 0.4); }
        .choice-btn:active { transform: scale(0.98); }
        .choice-btn.selected {
            background: linear-gradient(135deg, #A8E6CF, #9DD9BC);
            border-color: #5FA894;
            box-shadow: 0 0 25px rgba(95, 168, 148, 0.5), 0 4px 15px rgba(168, 230, 207, 0.4);
            transform: scale(1.03);
        }

        .choice-confirm-btn {
            background: linear-gradient(135deg, #5FA894, #4A6B5D);
            color: white; border: none; padding: 14px 40px;
            font-size: 15px; letter-spacing: 2px; cursor: pointer;
            border-radius: 30px; transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(95, 168, 148, 0.3);
            display: inline-flex; align-items: center; gap: 12px;
            justify-content: center; margin: 0 auto;
        }
        .choice-confirm-btn:hover:not(:disabled) { transform: translateY(-2px); }
        .choice-confirm-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-owl { width: 28px; height: 28px; display: inline-block; flex-shrink: 0; }

        .ui-layer {
            position: absolute; z-index: 10;
            width: 100%; height: 100%;
            pointer-events: none;
            display: flex; flex-direction: column;
            justify-content: space-between; align-items: center;
            padding: 80px 20px 60px 20px;
            transition: opacity 0.8s;
        }

        /* ËøôÈáåÁöÑ opacity: 0 ÊòØÂàùÂßãÁä∂ÊÄÅÔºåanimation Ë¢´ÁßªÈô§‰∫Ü */
        .hint-text {
            font-size: 16px; letter-spacing: 2px;
            color: #8FAFA0; text-align: center;
            opacity: 0; 
            text-shadow: 0 1px 5px rgba(255,255,255,0.8);
            transition: all 0.5s; line-height: 1.8; font-weight: 300;
        }

        /* Âè™ÊúâÊ∑ªÂä†‰∫ÜËøô‰∏™ visible Á±ªÔºåÂä®ÁîªÊâç‰ºöÂºÄÂßãÔºåÊñáÂ≠óÊâç‰ºöÂá∫Áé∞ */
        .hint-text.visible {
            animation: breathe 4s ease-in-out infinite;
        }

        @keyframes breathe { 0%, 100% { opacity: 0.75; } 50% { opacity: 0.95; } }

        .feedback-text {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px; letter-spacing: 2px; color: #5FA894;
            opacity: 0; pointer-events: none; z-index: 20;
            animation: feedbackFloat 1.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            max-width: 80%; text-align: center; word-wrap: break-word;
            white-space: pre-line; line-height: 2; padding: 20px; font-weight: 300;
        }
        .feedback-text.special {
            font-size: 20px; color: #D4A76A; font-weight: 400;
            text-shadow: 0 2px 10px rgba(255, 230, 200, 0.6);
            animation: feedbackFloatSpecial 2.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }
        @keyframes feedbackFloat {
            0% { opacity: 0; transform: translate(-50%, -45%); }
            15% { opacity: 1; }
            85% { opacity: 1; }
            100% { opacity: 0; transform: translate(-50%, -60%); }
        }
        @keyframes feedbackFloatSpecial {
            0% { opacity: 0; transform: translate(-50%, -45%) scale(0.95); }
            10% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            90% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -55%) scale(1.05); }
        }

        .flower-counter {
            position: absolute; bottom: 40px; right: 20px;
            font-size: 14px; color: #8FAFA0; letter-spacing: 1px;
            opacity: 0; transition: opacity 0.4s; pointer-events: none;
        }
        .flower-counter.show { opacity: 1; }

        .btn {
            background: linear-gradient(135deg, #A8E6CF, #DCEDC1);
            color: #4A6B5D; border: none; padding: 14px 36px;
            font-family: var(--font-stack); font-size: 15px; letter-spacing: 2px;
            font-weight: 300; cursor: pointer; border-radius: 50px;
            opacity: 0; transform: translateY(20px);
            transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            pointer-events: none;
            box-shadow: 0 10px 30px rgba(168, 230, 207, 0.25);
        }
        .btn:active { transform: scale(0.98) translateY(0); }
        .btn.visible { opacity: 1; transform: translateY(0); pointer-events: auto; }

        /* Êµ∑Êä•ÂºπÁ™ó */
        #poster-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(248, 248, 246, 0.98); z-index: 100;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.5s; padding: 20px;
        }
        #poster-modal.show { display: flex; opacity: 1; }
        #poster-img {
            max-width: 90%; max-height: 80vh; object-fit: contain;
            box-shadow: 0 25px 50px rgba(0,0,0,0.08); border-radius: 12px; margin-bottom: 20px;
        }
        .poster-info { text-align: center; max-width: 500px; }
        .poster-info p { font-size: 13px; color: #AAA; letter-spacing: 1px; margin: 10px 0; }
        .close-btn {
            margin-top: 20px; font-size: 28px; color: #CCC;
            cursor: pointer; padding: 10px; transition: color 0.3s;
        }
        .close-btn:hover { color: #999; }

        /* Èü≥‰πêÊéßÂà∂ */
        .music-control {
            position: fixed; top: 20px; right: 20px; width: 50px; height: 50px;
            background: rgba(168, 230, 207, 0.8); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 50; transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(168, 230, 207, 0.3); opacity: 0; pointer-events: none;
        }
        .music-control.visible { opacity: 1; pointer-events: auto; }
        .music-control:hover { background: rgba(168, 230, 207, 1); transform: scale(1.1); box-shadow: 0 6px 20px rgba(168, 230, 207, 0.5); }
        .music-control svg { width: 24px; height: 24px; fill: #4A6B5D; }
        .music-control.muted { background: rgba(189, 189, 189, 0.8); }
        .music-control.muted:hover { background: rgba(189, 189, 189, 1); }
    </style>
</head>
<body>

<div id="app">
    <canvas id="mainCanvas"></canvas>

    <div class="ui-layer" id="uiLayer">
        <div class="hint-text" id="topHint">ËΩªËΩªËß¶Á¢∞<br>Áõ¥Èù¢Á†¥Á¢é</div>
        <button class="btn" id="generateBtn">ÁèçËóèËøôÂ∫ßËä±Âõ≠</button>
        <div class="flower-counter" id="flowerCounter"></div>
    </div>
</div>

<audio id="bgMusic" loop preload="auto">
    <source src="flower.mp3" type="audio/mpeg">
</audio>

<div class="music-control" id="musicControl">
    <svg id="musicIcon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/>
        <path d="M14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
    </svg>
    <svg id="mutedIcon" style="display:none;" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
    </svg>
</div>

<div id="choice-modal">
    <div class="choice-content">
        <div class="choice-title">2026Ôºå‰Ω†ÊÉ≥ÂíåË∞Å‰∏ÄËµ∑ÈáçÊñ∞ÂºÄÂßãÔºü</div>
        <div class="choice-subtitle">(ÂèØ‰ª•ÈÄâÊã©Â§ö‰∏™)</div>
        <div class="choice-buttons" id="choiceButtons"></div>
        <button class="choice-confirm-btn" id="confirmBtn" disabled>
             <svg class="btn-owl" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <ellipse cx="50" cy="65" rx="28" ry="32" fill="#C9A877"/>
                <circle cx="50" cy="38" r="26" fill="#C9A877"/>
                <ellipse cx="50" cy="68" rx="18" ry="24" fill="#F0DCC8"/>
                <ellipse cx="32" cy="18" rx="7" ry="12" fill="#C9A877"/>
                <ellipse cx="32" cy="20" rx="4" ry="8" fill="#F0DCC8"/>
                <ellipse cx="68" cy="18" rx="7" ry="12" fill="#C9A877"/>
                <ellipse cx="68" cy="20" rx="4" ry="8" fill="#F0DCC8"/>
                <ellipse cx="40" cy="35" rx="10" ry="12" fill="white"/>
                <ellipse cx="60" cy="35" rx="10" ry="12" fill="white"/>
                <circle cx="40" cy="36" r="7" fill="#3D3D3D"/>
                <circle cx="42" cy="33" r="3" fill="white"/>
                <circle cx="60" cy="36" r="7" fill="#3D3D3D"/>
                <circle cx="62" cy="33" r="3" fill="white"/>
                <path d="M 50 48 Q 48 52 46 51" stroke="#D4A878" stroke-width="2" fill="none" stroke-linecap="round"/>
                <path d="M 50 48 Q 52 52 54 51" stroke="#D4A878" stroke-width="2" fill="none" stroke-linecap="round"/>
                <path d="M 50 44 L 48 46 L 50 47 L 52 46 Z" fill="#E8B88D"/>
                <path d="M 25 50 Q 20 55 22 65" stroke="#A68B6F" stroke-width="2" fill="none" opacity="0.6"/>
                <path d="M 25 58 Q 20 62 22 70" stroke="#A68B6F" stroke-width="2" fill="none" opacity="0.6"/>
                <path d="M 75 50 Q 80 55 78 65" stroke="#A68B6F" stroke-width="2" fill="none" opacity="0.6"/>
                <path d="M 75 58 Q 80 62 78 70" stroke="#A68B6F" stroke-width="2" fill="none" opacity="0.6"/>
                <path d="M 43 95 L 42 100 M 43 95 L 43 100 M 43 95 L 44 100" stroke="#D4A878" stroke-width="2" stroke-linecap="round"/>
                <path d="M 57 95 L 56 100 M 57 95 L 57 100 M 57 95 L 58 100" stroke="#D4A878" stroke-width="2" stroke-linecap="round"/>
            </svg>
            ÂíåÂΩíÂΩí‰∏ÄËµ∑ÁñóÊÑà
        </button>
    </div>
</div>

<div id="poster-modal">
    <img id="poster-img" src="" alt="Poster">
    <div class="poster-info">
        <p style="margin-top: 15px; color: #5FA894; font-weight: bold;">‰Ω†ÁöÑËä±Âõ≠Áã¨‰∏ÄÊó†‰∫å</p>
        <p id="poster-time"></p>
        <p>ÈïøÊåâ‰øùÂ≠òÂà∞Áõ∏ÂÜå</p>
    </div>
    <div class="close-btn" onclick="closeModal()">√ó</div>
</div>

<script>
const CONFIG = {
    colors: {
        plate: '#FDFDFD', plateDark: '#EFEFEF',
        grassBg: '#E9F7EF',
        flowerWhite: '#FFFAF0', flowerCenterYellow: '#F0D89F',
        flowerPink: '#E8C5D8', flowerCenterPink: '#D997BD',
        leafGreen: '#A8E6CF', leafDark: '#7CC9A8',
        lavenderPurple: '#D5CDD8', lavenderDark: '#B5ADB8',
        tulipPink: '#D8A8C8', tulipGreen: '#8DB88D',
        pansyPurple: '#C8BDD5', pansyYellow: '#E8D8A8',
        sunflowerYellow: '#F5D891', sunflowerBrown: '#D4A76A',
        lilyWhite: '#F8F5F0', lilyYellow: '#F0E8A8',
        roseRed: '#E8B8C5', rosePink: '#F0C8D8',
        forgetMeNotBlue: '#B8D8E8', forgetMeNotCenter: '#F0E8A8',
        jasmineWhite: '#F8F8F0', jasmineYellow: '#F5F0C8',
        lilyOfValleyWhite: '#F5F8F5', lilyOfValleyGreen: '#C8E8C8'
    },
    physics: { friction: 0.90, stopThreshold: 0.05 },
    draw: { minDistance: 35 } // ÊúÄÂ∞èÁªòÂà∂Èó¥Ë∑ù
};

const CHOICES = [
    'ÂíåËá™Â∑±ÈáçÊñ∞ÂºÄÂßã', 'ÂíåÂ§±ÂéªÁöÑÂèãÊÉÖÈáçÊñ∞ÂºÄÂßã', 'ÂíåÈÇ£‰∏™‰∫∫ÈáçÊñ∞ÂºÄÂßã',
    'ÂíåÊú™ÂÆûÁé∞ÁöÑÊ¢¶ÊÉ≥ÈáçÊñ∞ÂºÄÂßã', 'ÂíåÂØπËá™Â∑±ÁöÑÊúüÂæÖÈáçÊñ∞ÂºÄÂßã', 'ÂíåËøáÂéªÁöÑÈÅóÊÜæÈáçÊñ∞ÂºÄÂßã'
];

const MESSAGES_MAP = {
    'ÂíåËá™Â∑±ÈáçÊñ∞ÂºÄÂßã': ['ÂÖÅËÆ∏Ëá™Â∑±‰∏çÂÆåÁæé', '‰Ω†ÂÄºÂæóË¢´Ê∏©ÊüîÂØπÂæÖ', 'Á†¥Á¢éÁöÑ‰Ω†‰æùÁÑ∂Èó™ÂÖâ', 'ÊîæËøáËá™Â∑±ÊòØÊ∑±Ê∑±Ëá™Áà±', 'ÊÖ¢ÊÖ¢Êù•Ôºå‰Ω†Â∑≤Ë∂≥Â§üÂ•Ω', 'ÂØπËá™Â∑±ËØ¥Â£∞Ë∞¢Ë∞¢', 'Áº∫ÁÇπ‰πüÊòØÁã¨Áâπ', 'Â≠¶‰ºöÁà±Ëá™Â∑±', 'Êîæ‰∏ãÊòØÊúÄÂ•ΩÁöÑÂâçËøõ', 'ÂéüË∞ÖËá™Â∑±Âêß'],
    'ÂíåÂ§±ÂéªÁöÑÂèãÊÉÖÈáçÊñ∞ÂºÄÂßã': ['ÁúüËØö‰ºöÂ∏¶ÂõûÂØπÁöÑ‰∫∫', 'Â§±ÂéªÊïô‰ºö‰Ω†ÁèçÊÉú', '‰∏ã‰∏Ä‰∏™ÊúãÂèãÊõ¥ÊáÇ‰Ω†', 'ÊõæÁªèÁöÑÈô™‰º¥ÊòØÁúüÁöÑ', 'Ë£ÇÁºùÈáåÈïøÂá∫ÂÆΩÊÅï', '‰Ω†ÊúâËÉΩÂäõÂéªÂéüË∞Ö', '‰Ω†‰ºöÊõ¥Ê∏©ÊüîÂæÖ‰∫∫', '‰Ω†Ê∞∏‰∏çÂ≠§Âçï', 'Â§±ÂéªÊòØÂè¶‰∏ÄÊÆµÂºÄÂßã', '‰Ω†ÁöÑÁúüÂøÉÂÄºÂæó'],
    'ÂíåÈÇ£‰∏™‰∫∫ÈáçÊñ∞ÂºÄÂßã': ['‰∏∫‰∫ÜÈáçÁîüËÄåÂºÄÁöÑËä±', 'ÂéüË∞ÖÊòØÁªôËá™Â∑±ÁöÑÁ§ºÁâ©', '‰Ω†ÂÄºÂæóË¢´Áà±', 'Ê≤°‰∫∫ËÉΩÂÆö‰πâ‰Ω†ÁöÑ‰ª∑ÂÄº', '‰ºöÊúâÁèçÊÉú‰Ω†ÁöÑ‰∫∫', 'Áà±ËøáÂ∞±Ë∂≥Â§ü‰∫Ü', 'ÊîæÊâã‰πüÊòØ‰∏ÄÁßçÁà±', 'Ê∏©Êüî‰ºöÂú®Âà´Â§ÑË¢´ÁúãËßÅ', 'Êúâ‰∫õ‰∫∫Âè™ÊòØËøáÂÆ¢', 'Áà±ÊîπÂèò‰∫Ü‰Ω†'],
    'ÂíåÊú™ÂÆûÁé∞ÁöÑÊ¢¶ÊÉ≥ÈáçÊñ∞ÂºÄÂßã': ['Ê¢¶ÊÉ≥ÁöÑË∑ØËøòÂæàÈïø', 'ÊîπÂèòÊñπÂêëÊòØÊô∫ÊÖß', '‰Ω†ÊØîÊò®Â§©Êõ¥Êé•Ëøë‰∫Ü', 'Â∞ùËØïÂ°ëÈÄ†Êõ¥Â•ΩÁöÑ‰Ω†', 'Ê¢¶ÊÉ≥‰ºöÁ≠â‰Ω†', 'Â§±Ë¥•ÊòØÂøÖÈ°ªÁöÑÈì∫Âû´', 'ÂÖÅËÆ∏Ëá™Â∑±Ë∞ÉÊï¥ÊñπÂêë', 'Êîæ‰∏ãÊòØ‰∏∫‰∫ÜÂá∫Âèë', '‰Ω†ÊúâÁöÑÊòØÊó∂Èó¥', 'ÂºØË∑Ø‰πüÊòØË∑Ø'],
    'ÂíåÂØπËá™Â∑±ÁöÑÊúüÂæÖÈáçÊñ∞ÂºÄÂßã': ['‰∏çÈúÄË¶ÅÂÆåÁæéÂè™Ê±ÇÁúüÂÆû', 'ÊîæËøáËá™Â∑±ÁöÑËä±', 'ÊúüÂæÖÂ§™È´òÊòØ‰º§ÂÆ≥', '‰Ω†Â∑≤ÁªèÂÅöÂæóÂæàÂ•Ω‰∫Ü', 'ÂÅöÊúÄÂ•ΩÁöÑËá™Â∑±', 'ËøõÊ≠•‰∏çÊòØÁõ¥Á∫ø', 'Êîæ‰∏ãÊúüÂæÖÊâçÂø´‰πê', '‰ª∑ÂÄº‰∏çÁî±ÊúüÂæÖÂÆö‰πâ', 'Êé•Á∫≥‰∏çÂÆåÁæé', 'ÂÆåÁæéÂè™Âú®ÂπªÊÉ≥‰∏≠'],
    'ÂíåËøáÂéªÁöÑÈÅóÊÜæÈáçÊñ∞ÂºÄÂßã': ['ÈÅóÊÜæ‰πüÊòØÂäõÈáèÊù•Ê∫ê', '‰∏éËøáÂéªÂíåËß£', 'ËøáÂéªÂ∑≤ÂéªÊú™Êù•Â∞ÜÊù•', 'ÈÅóÊÜæÊïô‰ºö‰Ω†ÁèçÊÉú', 'ÈîôËØØÊàêÂ∞±Áé∞Âú®ÁöÑ‰Ω†', 'ÂéüË∞ÖËøáÂéªÊã•Êä±Êú™Êù•', 'ÈÅóÊÜæÊòØÊàêÈïøËØÅÊòé', 'ÊîπÂèòÂØπËøáÂéªÁöÑÁúãÊ≥ï', 'ÈÅóÊÜæÂÖªÂàÜÈáåÂºÄÂá∫Ëä±', 'Ê≤°ÂÅöÊàê‰πüÊòØ‰∏ÄÁßçÂèØËÉΩ']
};

let displayedIndices = {};
let appearedFlowerTypes = new Set();
const FLOWER_MEANINGS = [
    { name: 'ÈõèËèä', meaning: 'Á∫ØÁúü‰∏éÂ∏åÊúõ' }, { name: 'Ê®±Ëä±', meaning: 'ÁèçÊÉúÂΩì‰∏ã' },
    { name: '‰∏âÂè∂Ëçâ', meaning: 'Âπ∏Ëøê‰∏éÁ•ùÁ¶è' }, { name: 'Ëñ∞Ë°£Ëçâ', meaning: 'ÂÆÅÈùô‰∏éÊ≤ªÊÑà' },
    { name: 'ÈÉÅÈáëÈ¶ô', meaning: 'ÁæéÂ•Ω‰∏éÁ•ùÁ¶è' }, { name: '‰∏âËâ≤Â†á', meaning: 'ÊÄùÂøµ‰∏éÂõûÂøÜ' },
    { name: 'ÂêëÊó•Ëëµ', meaning: 'Èò≥ÂÖâ‰∏éÂãáÊ∞î' }, { name: 'ÁôæÂêà', meaning: 'Á∫ØÊ¥Å‰∏éÈáçÁîü' },
    { name: 'Áé´Áë∞', meaning: 'Áà±‰∏éÂùöÂº∫' }, { name: 'ÂãøÂøòÊàë', meaning: 'Ê∞∏ÊÅíÁöÑËÆ∞ÂøÜ' },
    { name: 'ËåâËéâËä±', meaning: 'Ê∏©Êüî‰∏éÁ∫ØÁúü' }, { name: 'ÈìÉÂÖ∞', meaning: 'Âπ∏Á¶èÂΩíÊù•' }
];

function initDisplayedIndices() {
    CHOICES.forEach(choice => { displayedIndices[choice] = new Set(); });
}

function getRandomMessage() {
    if(selectedChoices.length === 0) return 'üå∏';
    const choice = selectedChoices[Math.floor(Math.random() * selectedChoices.length)];
    const messages = MESSAGES_MAP[choice] || [];
    if(messages.length === 0) return 'ËøôÊúµËä±‰∏∫‰Ω†ËÄåÂºÄ';
    
    // ÁÆÄÂçïÈöèÊú∫Ôºå‰∏çÂÜçÂº∫Âà∂ÂéªÈáçÔºå‰øùÊåÅËΩªÈáè
    return messages[Math.floor(Math.random() * messages.length)];
}

const FEEDBACKS = { break: 'ÊÑüÂèóÂà∞‰Ω†‰∫Ü', flower1: 'Á¨¨‰∏ÄÊúµÂ∏åÊúõ', flower3: 'ÁîüÂëΩÂú®ËãèÈÜí', flower5: '‰Ω†ÂÅöÂæàÊ£í' };
const STATE = { CHOICE: -1, IDLE: 0, BROKEN: 1, GARDENING: 2 };

let currentState = STATE.CHOICE;
let selectedChoices = [];
let width, height, centerX, centerY;
let shards = [], flowers = [], particles = [];
let dpr = window.devicePixelRatio || 2;
const canvas = document.getElementById('mainCanvas');
const ctx = canvas.getContext('2d');
const hintText = document.getElementById('topHint');
const counterEl = document.getElementById('flowerCounter');

// ÁªòÂà∂Áõ∏ÂÖ≥ÂèòÈáè
let isDrawing = false;
let lastDrawPos = { x: 0, y: 0 };

class Particle {
    constructor(x, y) {
        this.x = x; this.y = y;
        this.vx = (Math.random() - 0.5) * 1.5;
        this.vy = (Math.random() - 0.5) * 1.5 - 0.5; // Á®çÂæÆÂêë‰∏äÈ£ò
        this.life = 1.0;
        this.decay = 0.02 + Math.random() * 0.02;
        this.size = 1 + Math.random() * 2;
        this.color = Math.random() > 0.5 ? '255, 230, 200' : '168, 230, 207'; // ÈáëËâ≤ÊàñÊ∑°ÁªøËâ≤
    }
    update() {
        this.x += this.vx; this.y += this.vy;
        this.life -= this.decay;
    }
    draw(ctx) {
        ctx.fillStyle = `rgba(${this.color}, ${this.life})`;
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
        ctx.fill();
    }
}

class Shard {
    constructor(c, as, ae, e1, e2, r) {
        this.centerOrigin={...c}; this.r=r; this.x=c.x; this.y=c.y;
        this.rot=0; this.vx=0; this.vy=0; this.vr=0;
        this.as=as; this.ae=ae; this.e1=e1; this.e2=e2;
        this.breatheOffset = Math.random() * Math.PI * 2;
    }
    explode() { 
        const m=(this.as+this.ae)/2; 
        const baseForce = Math.min(width, height) * 0.015; 
        const f = baseForce * (0.8 + Math.random() * 0.4); 
        this.vx=Math.cos(m)*f; this.vy=Math.sin(m)*f; this.vr=(Math.random()-0.5)*0.05;
    }
    update() { 
        if(currentState===STATE.BROKEN){ 
            this.x+=this.vx; this.y+=this.vy; this.rot+=this.vr; 
            this.vx*=CONFIG.physics.friction; this.vy*=CONFIG.physics.friction; this.vr*=CONFIG.physics.friction; 
            return (Math.abs(this.vx)<CONFIG.physics.stopThreshold&&Math.abs(this.vy)<CONFIG.physics.stopThreshold); 
        } 
        return true; 
    }
    draw(ctx) {
        ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.rot);
        const breatheScale = 1 + Math.sin(Date.now() / 3000 + this.breatheOffset) * 0.02;
        ctx.scale(breatheScale, breatheScale);
        ctx.beginPath();
        const r = this.r, c = 15;
        const dl = (a, n, rev) => {
            for(let i = (rev ? c : 0); rev ? i >= 0 : i <= c; rev ? i-- : i++) {
                const d = (i / c) * r;
                const off = (n[i - (rev ? 0 : 1)] || 0) * (r * 0.04);
                ctx.lineTo(Math.cos(a) * d + Math.cos(a + Math.PI / 2) * off, Math.sin(a) * d + Math.sin(a + Math.PI / 2) * off);
            }
        };
        dl(this.as, this.e1, false); ctx.arc(0, 0, r, this.as, this.ae); dl(this.ae, this.e2, true);
        ctx.closePath();
        const g = ctx.createRadialGradient(0, 0, 0, 0, 0, r);
        g.addColorStop(0, '#FFF'); g.addColorStop(1, CONFIG.colors.plateDark);
        ctx.fillStyle = g; ctx.shadowColor = 'rgba(0,0,0,0.06)';
        ctx.shadowBlur = 15; ctx.shadowOffsetY = 8; ctx.fill(); ctx.restore();
    }
}

class Flower {
    constructor(x,y) {
        this.x=x; this.y=y; this.s=0; this.ts=0.4+Math.random()*0.5;
        this.rot=Math.random()*Math.PI*2;
        this.t=Math.floor(Math.random()*12);
        this.wo=Math.random()*100;
        this.isSpecial = Math.random() < 0.10;
        if(this.isSpecial) {
            this.size = 1.6 + Math.random() * 0.4; this.glow = true; this.glowPhase = 0; this.glowIntensity = 0.4;
        } else {
            this.glow = Math.random() < 0.15; this.glowPhase = 0; this.size = 0.8 + Math.random() * 0.6; this.glowIntensity = 0.3;
        }
    }
    update() {
        this.s+=(this.ts-this.s)*0.15;
        if(this.glow) this.glowPhase = (this.glowPhase + 0.05) % (Math.PI * 2);
    }
    draw(ctx) {
        ctx.save(); ctx.translate(this.x,this.y);
        const w=Math.sin(Date.now()/500+this.wo)*0.05; ctx.rotate(this.rot+w);
        ctx.scale(this.s * this.size, this.s * this.size);
        if(this.glow) {
            const glowOpacity = Math.sin(this.glowPhase) * this.glowIntensity + this.glowIntensity;
            ctx.shadowColor = this.isSpecial ? `rgba(255, 230, 200, ${glowOpacity})` : `rgba(255, 215, 0, ${glowOpacity})`;
            ctx.shadowBlur = this.isSpecial ? 35 : 20;
        }
        if(this.t===0)this.dDaisy(ctx); else if(this.t===1)this.dSakura(ctx); else if(this.t===2)this.dClover(ctx);
        else if(this.t===3)this.dLavender(ctx); else if(this.t===4)this.dTulip(ctx); else if(this.t===5)this.dPansy(ctx);
        else if(this.t===6)this.dSunflower(ctx); else if(this.t===7)this.dLily(ctx); else if(this.t===8)this.dRose(ctx);
        else if(this.t===9)this.dForgetMeNot(ctx); else if(this.t===10)this.dJasmine(ctx); else this.dLilyOfValley(ctx);
        ctx.restore(); 
    }
    dDaisy(ctx) { ctx.fillStyle=CONFIG.colors.flowerWhite; for(let i=0;i<8;i++){ctx.beginPath();ctx.rotate(Math.PI*2/8);ctx.ellipse(15,0,10,5,0,0,Math.PI*2);ctx.fill();} ctx.beginPath();ctx.arc(0,0,8,0,Math.PI*2);ctx.fillStyle=CONFIG.colors.flowerCenterYellow;ctx.fill(); }
    dSakura(ctx) { ctx.fillStyle=CONFIG.colors.flowerPink; for(let i=0;i<5;i++){ctx.beginPath();ctx.rotate(Math.PI*2/5);ctx.moveTo(0,0);ctx.quadraticCurveTo(10,-10,20,0);ctx.quadraticCurveTo(10,10,0,0);ctx.fill();} ctx.beginPath();ctx.arc(0,0,5,0,Math.PI*2);ctx.fillStyle=CONFIG.colors.flowerCenterPink;ctx.fill(); }
    dClover(ctx) { ctx.fillStyle=CONFIG.colors.leafGreen; ctx.beginPath();ctx.ellipse(-8,-5,12,6,Math.PI/4,0,Math.PI*2);ctx.fill(); ctx.beginPath();ctx.ellipse(8,-5,12,6,-Math.PI/4,0,Math.PI*2);ctx.fill(); ctx.strokeStyle=CONFIG.colors.leafDark;ctx.lineWidth=2;ctx.lineCap='round';ctx.beginPath();ctx.moveTo(0,0);ctx.quadraticCurveTo(0,10,-2,20);ctx.stroke(); }
    dLavender(ctx) { ctx.fillStyle=CONFIG.colors.lavenderPurple; for(let i=0;i<4;i++){for(let j=0;j<3;j++){ctx.beginPath();ctx.arc(-8+i*5, -5+j*5, 3, 0, Math.PI*2);ctx.fill();}} ctx.strokeStyle=CONFIG.colors.lavenderDark;ctx.lineWidth=1.5;ctx.beginPath();ctx.moveTo(0,0);ctx.quadraticCurveTo(-3,8,0,18);ctx.stroke(); }
    dTulip(ctx) { ctx.fillStyle=CONFIG.colors.tulipPink; for(let i=0;i<3;i++){ctx.beginPath();ctx.rotate(Math.PI*2/3);ctx.moveTo(0,-15);ctx.quadraticCurveTo(8,-5,5,5);ctx.quadraticCurveTo(0,8,-5,5);ctx.quadraticCurveTo(-8,-5,0,-15);ctx.fill();} ctx.strokeStyle=CONFIG.colors.tulipGreen;ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(0,5);ctx.lineTo(0,20);ctx.stroke(); }
    dPansy(ctx) { ctx.fillStyle=CONFIG.colors.pansyPurple; for(let i=0;i<5;i++){ctx.beginPath();ctx.rotate(Math.PI*2/5);ctx.ellipse(0,-10,8,10,0,0,Math.PI*2);ctx.fill();} ctx.beginPath();ctx.arc(0,0,6,0,Math.PI*2);ctx.fillStyle=CONFIG.colors.pansyYellow;ctx.fill(); ctx.fillStyle='#8B8B8B';ctx.beginPath();ctx.arc(-2,-1,2,0,Math.PI*2);ctx.fill(); }
    dSunflower(ctx) { ctx.fillStyle=CONFIG.colors.sunflowerYellow; for(let i=0;i<12;i++){ctx.beginPath();ctx.rotate(Math.PI*2/12);ctx.ellipse(18,0,12,5,0,0,Math.PI*2);ctx.fill();} ctx.beginPath();ctx.arc(0,0,10,0,Math.PI*2);ctx.fillStyle=CONFIG.colors.sunflowerBrown;ctx.fill(); }
    dLily(ctx) { ctx.fillStyle=CONFIG.colors.lilyWhite; for(let i=0;i<6;i++){ctx.beginPath();ctx.rotate(Math.PI*2/6);ctx.moveTo(0,0);ctx.quadraticCurveTo(5,-18,0,-22);ctx.quadraticCurveTo(-5,-18,0,0);ctx.fill();} for(let i=0;i<6;i++){ctx.fillStyle=CONFIG.colors.lilyYellow;ctx.beginPath();ctx.arc(Math.cos(i*Math.PI/3)*5, Math.sin(i*Math.PI/3)*5, 2, 0, Math.PI*2);ctx.fill();} }
    dRose(ctx) { ctx.fillStyle=CONFIG.colors.roseRed; for(let i=0;i<3;i++){ctx.beginPath();ctx.rotate(Math.PI*2/3);ctx.ellipse(0,-8,6,8,0,0,Math.PI*2);ctx.fill();} ctx.fillStyle=CONFIG.colors.rosePink; for(let i=0;i<5;i++){ctx.beginPath();ctx.rotate(Math.PI*2/5);ctx.ellipse(0,-15,8,10,0,0,Math.PI*2);ctx.fill();} }
    dForgetMeNot(ctx) { ctx.fillStyle=CONFIG.colors.forgetMeNotBlue; for(let i=0;i<5;i++){ctx.beginPath();ctx.rotate(Math.PI*2/5);ctx.arc(8,0,6,0,Math.PI*2);ctx.fill();} ctx.beginPath();ctx.arc(0,0,4,0,Math.PI*2);ctx.fillStyle=CONFIG.colors.forgetMeNotCenter;ctx.fill(); }
    dJasmine(ctx) { ctx.fillStyle=CONFIG.colors.jasmineWhite; for(let i=0;i<5;i++){ctx.beginPath();ctx.rotate(Math.PI*2/5);ctx.moveTo(0,0);ctx.lineTo(10,-5);ctx.lineTo(12,0);ctx.lineTo(10,5);ctx.closePath();ctx.fill();} ctx.beginPath();ctx.arc(0,0,3,0,Math.PI*2);ctx.fillStyle=CONFIG.colors.jasmineYellow;ctx.fill(); }
    dLilyOfValley(ctx) { ctx.fillStyle=CONFIG.colors.lilyOfValleyWhite; for(let i=0;i<3;i++){ctx.save();ctx.translate(-10+i*10, i*8);ctx.beginPath();ctx.moveTo(-5,-8);ctx.quadraticCurveTo(-6,-2,-4,2);ctx.quadraticCurveTo(0,4,4,2);ctx.quadraticCurveTo(6,-2,5,-8);ctx.closePath();ctx.fill();ctx.restore();} ctx.strokeStyle=CONFIG.colors.lilyOfValleyGreen;ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(0,0);ctx.quadraticCurveTo(-5,10,0,24);ctx.stroke(); }
}

function showFeedback(text, isSpecial = false) {
    document.querySelectorAll('.feedback-text').forEach(el => el.remove());
    const el = document.createElement('div');
    el.className = 'feedback-text';
    if(isSpecial) el.classList.add('special');
    el.textContent = text;
    document.getElementById('uiLayer').appendChild(el);
    setTimeout(() => el.remove(), isSpecial ? 3000 : 2000);
}

function updateCounter() {
    const count = flowers.length;
    if(count > 0) { counterEl.classList.add('show'); counterEl.textContent = `üå∏ √ó${count}`; }
}

function initScene() {
    shards=[]; flowers=[]; particles=[]; appearedFlowerTypes.clear(); const c=6; 
    const isMobile = width < 600;
    const sizeRatio = isMobile ? 0.33 : 0.38;
    const r = Math.min(width, height) * sizeRatio; 
    let ang=[]; for(let i=0;i<c;i++)ang.push(Math.random()+0.2); 
    const sum=ang.reduce((a,b)=>a+b,0); 
    let curA=0; let aPts=ang.map(a=>{curA+=(a/sum)*Math.PI*2;return curA;}); 
    const ns=[]; for(let i=0;i<c;i++){let n=[];for(let k=0;k<15;k++)n.push(Math.random()-0.5);ns.push(n);}
    for(let i=0;i<c;i++){ 
        const s=(i==0)?aPts[c-1]-Math.PI*2:aPts[i-1]; 
        const e=aPts[i]; 
        shards.push(new Shard({x:centerX,y:centerY},s,e,(i==0)?ns[c-1]:ns[i-1],ns[i],r)); 
    }
}

function resize() { 
    width=window.innerWidth; height=window.innerHeight; 
    canvas.width=width*dpr; canvas.height=height*dpr; 
    canvas.style.width=width+'px'; canvas.style.height=height+'px'; 
    ctx.scale(dpr,dpr); centerX=width/2; centerY=height/2; 
    if(currentState>=STATE.IDLE)initScene(); 
}

function trySpawnFlower(x, y, isDrag = false) {
    const dist = Math.hypot(x - lastDrawPos.x, y - lastDrawPos.y);
    const inPlate = Math.hypot(x-centerX, y-centerY) < Math.min(width,height)*0.48;

    // Â¶ÇÊûúÊòØÁÇπÂáª(ÈùûÊãñÊãΩ)ÊàñËÄÖË∑ùÁ¶ªË∂≥Â§üËøúÔºå‰∏îÂú®ÁõòÂ≠êËåÉÂõ¥ÂÜÖ
    if (inPlate && (!isDrag || dist > CONFIG.draw.minDistance)) {
        const newFlower = new Flower(x, y);
        flowers.push(newFlower);
        updateCounter();
        lastDrawPos = { x, y };
        
        // ‰∫ßÁîüÂÖâÊïà
        for(let k=0; k<3; k++) {
            particles.push(new Particle(x, y));
        }

        const count = flowers.length;

        // „Äê‰ºòÂåñ„ÄëÁªòÂà∂Á¨¨‰∏ÄÊúµËä±Êó∂ÔºåÈöêËóèÈ°∂ÈÉ®ÁöÑ‚ÄúËΩªËΩªËß¶Á¢∞‚ÄùÂºïÂØºËØ≠
        if(count === 1) {
            hintText.classList.remove('visible'); 
        }
        
        // ÂèçÈ¶àÈÄªËæë‰ºòÂåñ
        if (newFlower.isSpecial) {
             const flower = FLOWER_MEANINGS[newFlower.t];
             if(!appearedFlowerTypes.has(newFlower.t)) {
                 appearedFlowerTypes.add(newFlower.t);
                 showFeedback(`‚ú® ${flower.name} ‚ú®\n${flower.meaning}`, true);
             } else {
                 if(Math.random() < 0.2) showFeedback(getRandomMessage(), true);
             }
        } else if (count <= 10) {
            if(!isDrag || Math.random() < 0.3) {
                if (count === 1) showFeedback(FEEDBACKS.flower1);
                else if (count === 3) showFeedback(FEEDBACKS.flower3);
                else if (count === 5) showFeedback(FEEDBACKS.flower5);
                else showFeedback(getRandomMessage());
            }
        }

        // „Äê‰ºòÂåñ„ÄëÁªòÂà∂Á¨¨‰∏âÊúµËä±Êó∂ÔºåÊòæÁ§∫Êñ∞ÁöÑÂºïÂØºËØ≠
        if(count === 3){
            setTimeout(()=>{ 
                hintText.innerHTML="ÊØè‰∏ÄÈÅì‰º§Áóï<br>ÈÉΩËÉΩÂºÄÂá∫Ëä±Êù•"; 
                hintText.classList.add('visible'); 
            }, 500);
        }
        if(count>5) document.getElementById('generateBtn').classList.add('visible'); 
    }

    if(isDrag && inPlate) {
        if(Math.random() < 0.5) particles.push(new Particle(x, y));
    }
}

// Áªü‰∏ÄËæìÂÖ•Â§ÑÁêÜ
function handleInputStart(e) {
    e.preventDefault();
    if (currentState === STATE.IDLE) {
        currentState = STATE.BROKEN;
        hintText.innerHTML = "ËØïÁùÄËß¶Á¢∞ÈÇ£‰∫õ<br>Á†¥Á¢éÁöÑÂú∞Êñπ...";
        shards.forEach(s => s.explode());
        showFeedback(FEEDBACKS.break);
        setTimeout(() => { 
            currentState = STATE.GARDENING; 
            hintText.innerHTML = "ÁÇπËêΩÊàêËä±ÔºåÊåáÂºïÊò•ÊÑè<br>ÁªòÂá∫‰Ω†ÁöÑËä±Âõ≠"; 
        }, 800);
    } else if (currentState === STATE.GARDENING) {
        isDrawing = true;
        const x = e.touches ? e.touches[0].clientX : e.clientX;
        const y = e.touches ? e.touches[0].clientY : e.clientY;
        lastDrawPos = { x: -100, y: -100 }; // ‰øùËØÅÁ¨¨‰∏ÄÊ¨°ÁÇπÂáªÂøÖÁîüÊàê
        trySpawnFlower(x, y, false);
    }
}

function handleInputMove(e) {
    e.preventDefault();
    if (currentState === STATE.GARDENING && isDrawing) {
        const x = e.touches ? e.touches[0].clientX : e.clientX;
        const y = e.touches ? e.touches[0].clientY : e.clientY;
        trySpawnFlower(x, y, true);
    }
}

function handleInputEnd(e) {
    isDrawing = false;
}

// ‰∫ã‰ª∂ÁªëÂÆö
canvas.addEventListener('mousedown', handleInputStart);
canvas.addEventListener('mousemove', handleInputMove);
window.addEventListener('mouseup', handleInputEnd);

canvas.addEventListener('touchstart', handleInputStart, { passive: false });
canvas.addEventListener('touchmove', handleInputMove, { passive: false });
window.addEventListener('touchend', handleInputEnd);


function initChoiceModal() {
    const buttonsContainer = document.getElementById('choiceButtons');
    const confirmBtn = document.getElementById('confirmBtn');
    initDisplayedIndices();
    CHOICES.forEach(choice => {
        const btn = document.createElement('button');
        btn.className = 'choice-btn';
        btn.textContent = choice;
        btn.addEventListener('click', () => {
            startMusic();
            btn.classList.toggle('selected');
            selectedChoices = [];
            document.querySelectorAll('.choice-btn.selected').forEach(b => { selectedChoices.push(b.textContent); });
            confirmBtn.disabled = selectedChoices.length === 0;
        });
        buttonsContainer.appendChild(btn);
    });

    confirmBtn.addEventListener('click', () => {
        if(selectedChoices.length > 0) {
            startMusic();
            document.getElementById('choice-modal').classList.remove('show');
            setTimeout(() => { 
                currentState = STATE.IDLE; 
                initScene(); 
                // „Äê‰øÆÂ§ç„ÄëÁÇπÂáªÁ°ÆËÆ§ÂêéÔºåÊâçÁªôÂºïÂØºËØ≠Âä†‰∏ävisibleÁ±ªÔºåËÆ©ÂÆÉÂá∫Áé∞
                hintText.classList.add('visible'); 
            }, 600);
        }
    });
}

document.getElementById('musicControl').addEventListener('click', () => {
    const bgMusic = document.getElementById('bgMusic');
    const musicControl = document.getElementById('musicControl');
    const musicIcon = document.getElementById('musicIcon');
    const mutedIcon = document.getElementById('mutedIcon');
    if(bgMusic.paused) {
        bgMusic.play(); musicControl.classList.remove('muted'); musicIcon.style.display = 'block'; mutedIcon.style.display = 'none';
    } else {
        bgMusic.pause(); musicControl.classList.add('muted'); musicIcon.style.display = 'none'; mutedIcon.style.display = 'block';
    }
});

document.getElementById('generateBtn').addEventListener('click', () => {
    const baseWidth = width < 750 ? 1080 : width * 2;
    const posterWidth = baseWidth;
    const posterHeight = posterWidth * (5 / 3);
    const pc = document.createElement('canvas');
    pc.width = posterWidth; pc.height = posterHeight;
    const pCtx = pc.getContext('2d');
    
    pCtx.fillStyle = CONFIG.colors.grassBg;
    pCtx.fillRect(0, 0, pc.width, pc.height);
    
    pCtx.save();
    const scaleFactor = posterWidth / width;
    pCtx.scale(scaleFactor, scaleFactor);
    const scaledPosterHeight = posterHeight / scaleFactor;
    const verticalShift = (scaledPosterHeight / 2) - centerY;
    pCtx.translate(0, verticalShift);
    shards.forEach(s => s.draw(pCtx));
    flowers.forEach(f => f.draw(pCtx));
    pCtx.restore();
    
    const fontSizeMain = posterWidth * 0.045;
    const fontSizeSub = posterWidth * 0.025;
    pCtx.fillStyle = '#5A7A6A';
    pCtx.textAlign = 'center';
    pCtx.font = `${fontSizeMain}px serif`;
    const quotes = ["ÂÖÅËÆ∏Á†¥Á¢éÔºå‰πüËÉΩËøéÊù•ÁªΩÊîæ", "Âú®ÁîüÂëΩÁöÑË£ÇÈöô‰∏≠ÔºåÂºÄÂá∫Â∏åÊúõ", "‰Ω†‰æùÁÑ∂ÂÆåÊï¥ÔºåÂè™ÊòØÊç¢‰∫Ü‰∏ÄÁßçÂßøÊÄÅÁõõÂºÄ"];
    pCtx.fillText(quotes[Math.floor(Math.random()*quotes.length)], posterWidth / 2, posterHeight * 0.85);
    pCtx.fillStyle = '#8FAFA0';
    pCtx.font = `${fontSizeSub}px serif`;
    const gardenNo = Math.floor(Math.random()*9000+1000);
    pCtx.fillText("„ÄåÁ†¥Á¢éÈáçÊï¥ËÆ°Âàí„ÄçÊ≤ªÊÑàËä±Âõ≠ No." + gardenNo, posterWidth / 2, posterHeight * 0.94);

    document.getElementById('poster-img').src = pc.toDataURL('image/png');
    const now = new Date();
    const dateStr = `${now.getFullYear()}.${String(now.getMonth()+1).padStart(2,'0')}.${String(now.getDate()).padStart(2,'0')}`;
    document.getElementById('poster-time').textContent = `ÁîüÊàêÊó∂Èó¥Ôºö${dateStr}`;
    document.getElementById('poster-modal').classList.add('show');
    document.getElementById('poster-modal').style.display = 'flex';
});

function closeModal() {
    document.getElementById('poster-modal').classList.remove('show');
    setTimeout(() => document.getElementById('poster-modal').style.display = 'none', 400);
}

function animate() { 
    ctx.clearRect(0,0,width,height); 
    if(currentState===STATE.BROKEN) shards.forEach(s=>s.update()); 
    shards.forEach(s=>s.draw(ctx)); 
    flowers.forEach(f=>{f.update();f.draw(ctx);});
    
    // Êõ¥Êñ∞Á≤íÂ≠ê
    for(let i=particles.length-1; i>=0; i--) {
        particles[i].update();
        particles[i].draw(ctx);
        if(particles[i].life <= 0) particles.splice(i, 1);
    }
    
    requestAnimationFrame(animate); 
}

window.addEventListener('resize', resize);
initChoiceModal();
resize();
animate();

let musicStarted = false;
function startMusic() {
    if(musicStarted) return;
    musicStarted = true;
    const bgMusic = document.getElementById('bgMusic');
    bgMusic.volume = 0;
    bgMusic.play().then(() => {
        let targetVolume = 0.4;
        let fadeInInterval = setInterval(() => {
            if(bgMusic.volume < targetVolume) {
                bgMusic.volume = Math.min(bgMusic.volume + 0.02, targetVolume);
            } else { clearInterval(fadeInInterval); }
        }, 50);
        setTimeout(() => { document.getElementById('musicControl').classList.add('visible'); }, 1000);
    }).catch(err => { musicStarted = false; });
}
setTimeout(() => { startMusic(); }, 1000);
setTimeout(() => { document.getElementById('choice-modal').classList.add('show'); }, 500);
</script>
</body>
</html>
