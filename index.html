<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>破碎重整计划</title>
    <style>
        :root {
            --bg-color: #E9F7EF;
            --font-stack: "Songti SC", "Noto Serif SC", serif;
            --text-color: #5A5A5A;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body, html {
            width: 100%; height: 100%;
            background-color: var(--bg-color);
            overflow: hidden;
            font-family: var(--font-stack);
            color: var(--text-color);
            touch-action: none;
        }

        #app {
            position: relative; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
        }

        canvas { position: absolute; top: 0; left: 0; z-index: 1; }

        .ui-layer {
            position: absolute; z-index: 10;
            width: 100%; height: 100%;
            pointer-events: none;
            display: flex; flex-direction: column;
            justify-content: space-between; align-items: center;
            padding: 80px 20px;
            transition: opacity 0.8s;
        }

        .hint-text {
            font-size: 16px; letter-spacing: 2px;
            color: #999; text-align: center;
            opacity: 0.9;
            text-shadow: 0 1px 5px rgba(255,255,255,0.8);
            transition: all 0.5s;
        }

        .btn {
            background: linear-gradient(135deg, #A8E6CF, #DCEDC1);
            color: #4A6B5D; border: none;
            padding: 14px 36px;
            font-family: var(--font-stack);
            font-size: 15px; letter-spacing: 2px; font-weight: bold;
            cursor: pointer; border-radius: 50px;
            opacity: 0; transform: translateY(20px);
            transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            pointer-events: none;
            box-shadow: 0 10px 25px rgba(168, 230, 207, 0.4);
        }
        .btn:active { transform: scale(0.98) translateY(0); }
        .btn.visible { opacity: 1; transform: translateY(0); pointer-events: auto; }

        #poster-modal {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(248, 248, 246, 0.98);
            z-index: 100;
            display: none; flex-direction: column;
            align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.5s;
            padding: 20px;
        }
        #poster-modal.show { display: flex; opacity: 1; }
        #poster-img {
            max-width: 90%;
            max-height: 75vh; 
            object-fit: contain;
            box-shadow: 0 25px 50px rgba(0,0,0,0.08);
            border-radius: 12px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

<div id="app">
    <canvas id="mainCanvas"></canvas>
    
    <div class="ui-layer" id="uiLayer">
        <div class="hint-text" id="topHint">轻轻触碰<br>直面破碎</div>
        <button class="btn" id="generateBtn">珍藏这座花园</button>
    </div>
</div>

<div id="poster-modal">
    <img id="poster-img" src="" alt="Poster">
    <p style="font-size: 13px; color: #AAA; letter-spacing: 1px;">长按保存你的专属治愈海报</p>
    <div style="margin-top:20px; font-size: 28px; color:#CCC; cursor:pointer; padding:10px;" onclick="closeModal()">×</div>
</div>

<script>
/**
 * 破碎重整计划 V4.3 - 大比例圆盘版
 * 修改点：增大了圆盘相对于屏幕的初始半径比例。
 */

const CONFIG = {
    colors: {
        plate: '#FDFDFD', plateDark: '#EFEFEF',
        grassBg: '#E9F7EF', 
        flowerWhite: '#FFFAF0', flowerCenterYellow: '#FFD700',
        flowerPink: '#FFB7C5', flowerCenterPink: '#FF69B4',
        leafGreen: '#A8E6CF', leafDark: '#5FA894'
    },
    physics: { friction: 0.93, stopThreshold: 0.05 }
};

const STATE = { IDLE: 0, BROKEN: 1, GARDENING: 2 };
let currentState = STATE.IDLE;
let width, height, centerX, centerY;
let shards = [];
let flowers = [];
let dpr = window.devicePixelRatio || 2;
const canvas = document.getElementById('mainCanvas');
const ctx = canvas.getContext('2d');
const hintText = document.getElementById('topHint');

// --- 碎片与花朵类 (保持不变) ---
class Shard {
    constructor(c, as, ae, e1, e2, r) { this.centerOrigin={...c}; this.r=r; this.x=c.x; this.y=c.y; this.rot=0; this.vx=0; this.vy=0; this.vr=0; this.as=as; this.ae=ae; this.e1=e1; this.e2=e2; }
    explode() { const m=(this.as+this.ae)/2; const f=12*(0.9+Math.random()*0.4); this.vx=Math.cos(m)*f; this.vy=Math.sin(m)*f; this.vr=(Math.random()-0.5)*0.15; }
    update() { if(currentState===STATE.BROKEN){ this.x+=this.vx; this.y+=this.vy; this.rot+=this.vr; this.vx*=CONFIG.physics.friction; this.vy*=CONFIG.physics.friction; this.vr*=CONFIG.physics.friction; return (Math.abs(this.vx)<CONFIG.physics.stopThreshold&&Math.abs(this.vy)<CONFIG.physics.stopThreshold); } return true; }
    draw(ctx) { ctx.save(); ctx.translate(this.x,this.y); ctx.rotate(this.rot); ctx.beginPath(); const r=this.r; const c=15;
        const dl=(a,n,rev)=>{ for(let i=(rev?c:0); rev?i>=0:i<=c; rev?i--:i++){ const d=(i/c)*r; const off=(n[i-(rev?0:1)]||0)*(r*0.04); ctx.lineTo(Math.cos(a)*d+Math.cos(a+Math.PI/2)*off, Math.sin(a)*d+Math.sin(a+Math.PI/2)*off); }};
        dl(this.as,this.e1,false); ctx.arc(0,0,r,this.as,this.ae); dl(this.ae,this.e2,true); ctx.closePath();
        const g=ctx.createRadialGradient(0,0,0,0,0,r); g.addColorStop(0,'#FFF'); g.addColorStop(1,CONFIG.colors.plateDark); ctx.fillStyle=g; ctx.shadowColor='rgba(0,0,0,0.06)'; ctx.shadowBlur=15; ctx.shadowOffsetY=8; ctx.fill(); ctx.restore(); }
}
class Flower {
    constructor(x,y) { this.x=x; this.y=y; this.s=0; this.ts=0.4+Math.random()*0.5; this.rot=Math.random()*Math.PI*2; this.t=Math.floor(Math.random()*3); this.wo=Math.random()*100; }
    update() { this.s+=(this.ts-this.s)*0.15; }
    draw(ctx) { ctx.save(); ctx.translate(this.x,this.y); const w=Math.sin(Date.now()/500+this.wo)*0.05; ctx.rotate(this.rot+w); ctx.scale(this.s,this.s); if(this.t===0)this.dD(ctx); else if(this.t===1)this.dS(ctx); else this.dSp(ctx); ctx.restore(); }
    dD(ctx) { ctx.fillStyle=CONFIG.colors.flowerWhite; for(let i=0;i<8;i++){ctx.beginPath();ctx.rotate(Math.PI*2/8);ctx.ellipse(15,0,10,5,0,0,Math.PI*2);ctx.fill();} ctx.beginPath();ctx.arc(0,0,8,0,Math.PI*2);ctx.fillStyle=CONFIG.colors.flowerCenterYellow;ctx.fill(); }
    dS(ctx) { ctx.fillStyle=CONFIG.colors.flowerPink; for(let i=0;i<5;i++){ctx.beginPath();ctx.rotate(Math.PI*2/5);ctx.moveTo(0,0);ctx.quadraticCurveTo(10,-10,20,0);ctx.quadraticCurveTo(10,10,0,0);ctx.fill();} ctx.beginPath();ctx.arc(0,0,5,0,Math.PI*2);ctx.fillStyle=CONFIG.colors.flowerCenterPink;ctx.fill(); }
    dSp(ctx) { ctx.fillStyle=CONFIG.colors.leafGreen; ctx.beginPath();ctx.ellipse(-8,-5,12,6,Math.PI/4,0,Math.PI*2);ctx.fill(); ctx.beginPath();ctx.ellipse(8,-5,12,6,-Math.PI/4,0,Math.PI*2);ctx.fill(); ctx.strokeStyle=CONFIG.colors.leafDark;ctx.lineWidth=2;ctx.lineCap='round';ctx.beginPath();ctx.moveTo(0,0);ctx.quadraticCurveTo(0,10,-2,20);ctx.stroke(); }
}

// --- 初始化与交互 ---
function initScene() {
    shards=[]; flowers=[]; const c=6; 
    // --- 修改点：增大了圆盘半径比例，从 0.28 改为 0.36 ---
    const r=Math.min(width,height)*0.36; 
    let ang=[]; for(let i=0;i<c;i++)ang.push(Math.random()+0.2); const sum=ang.reduce((a,b)=>a+b,0); let curA=0; let aPts=ang.map(a=>{curA+=(a/sum)*Math.PI*2;return curA;}); const ns=[]; for(let i=0;i<c;i++){let n=[];for(let k=0;k<15;k++)n.push(Math.random()-0.5);ns.push(n);}
    for(let i=0;i<c;i++){ const s=(i==0)?aPts[c-1]-Math.PI*2:aPts[i-1]; const e=aPts[i]; shards.push(new Shard({x:centerX,y:centerY},s,e,(i==0)?ns[c-1]:ns[i-1],ns[i],r)); }
}
function resize() { width=window.innerWidth; height=window.innerHeight; canvas.width=width*dpr; canvas.height=height*dpr; canvas.style.width=width+'px'; canvas.style.height=height+'px'; ctx.scale(dpr,dpr); centerX=width/2; centerY=height/2; if(currentState===STATE.IDLE)initScene(); }

canvas.addEventListener('mousedown', handleClick); canvas.addEventListener('touchstart', handleClick, {passive:false});
function handleClick(e) { e.preventDefault(); if(currentState===STATE.IDLE){ currentState=STATE.BROKEN; hintText.innerHTML="试着触碰那些<br>破碎的地方..."; shards.forEach(s=>s.explode()); setTimeout(()=>{currentState=STATE.GARDENING;},800); }else if(currentState===STATE.GARDENING){ const pos=getPos(e); const dist=Math.hypot(pos.x-centerX,pos.y-centerY); if(dist<Math.min(width,height)*0.48){ flowers.push(new Flower(pos.x,pos.y)); if(flowers.length===3){hintText.style.opacity=0;setTimeout(()=>{hintText.innerHTML="每一处伤痕<br>都能开出花来";hintText.style.opacity=1;},500);} if(flowers.length>5)document.getElementById('generateBtn').classList.add('visible'); }}}
function getPos(e) { const t=e.touches?e.touches[0]:e; return {x:t.clientX,y:t.clientY}; }
function animate() { ctx.clearRect(0,0,width,height); if(currentState===STATE.BROKEN)shards.forEach(s=>s.update()); shards.forEach(s=>s.draw(ctx)); flowers.forEach(f=>{f.update();f.draw(ctx);}); requestAnimationFrame(animate); }

// --- 海报生成 (保持完美居中的竖版逻辑) ---
document.getElementById('generateBtn').addEventListener('click', () => {
    const posterWidth = width * 2; 
    const posterHeight = posterWidth * (5 / 3);
    const pc = document.createElement('canvas');
    pc.width = posterWidth; pc.height = posterHeight;
    const pCtx = pc.getContext('2d');
    
    pCtx.fillStyle = CONFIG.colors.grassBg;
    pCtx.fillRect(0, 0, pc.width, pc.height);
    
    pCtx.save();
    pCtx.scale(2, 2);
    const posterCenterY_Scaled = posterHeight / 4;
    const screenCenterY_Scaled = centerY;
    const verticalShift = posterCenterY_Scaled - screenCenterY_Scaled;
    pCtx.translate(0, verticalShift);
    shards.forEach(s => s.draw(pCtx));
    flowers.forEach(f => f.draw(pCtx));
    pCtx.restore();
    
    const fontSizeMain = posterWidth * 0.055;
    const fontSizeSub = posterWidth * 0.032;
    pCtx.fillStyle = '#5A7A6A';
    pCtx.textAlign = 'center';
    pCtx.font = `${fontSizeMain}px ${CONFIG.colors.fontStack}`;
    const quotes = ["允许破碎，也能迎来绽放", "在生命的裂隙中，开出希望", "你依然完整，只是换了一种姿态盛开"];
    pCtx.fillText(quotes[Math.floor(Math.random()*quotes.length)], posterWidth / 2, posterHeight * 0.82);
    pCtx.fillStyle = '#8FAFA0'; 
    pCtx.font = `${fontSizeSub}px ${CONFIG.colors.fontStack}`; letterSpacing = '2px';
    pCtx.fillText("「破碎重整计划」治愈花园 No." + Math.floor(Math.random()*9000+1000), posterWidth / 2, posterHeight * 0.87);

    document.getElementById('poster-img').src = pc.toDataURL('image/png');
    document.getElementById('poster-modal').classList.add('show');
    document.getElementById('poster-modal').style.display = 'flex';
});

function closeModal() {
    document.getElementById('poster-modal').classList.remove('show');
    setTimeout(() => document.getElementById('poster-modal').style.display = 'none', 400);
}

window.addEventListener('resize', resize); resize(); animate();
</script>
</body>

</html>
